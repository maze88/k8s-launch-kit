{{- if .Profile.Multirail -}}
{{- /* Create test pods for each separate IPoIB network (per PF) */ -}}
{{- range $i, $pf := .ClusterConfig.PFs}}
{{- if eq $pf.Traffic "east-west"}}
apiVersion: v1
kind: Pod
metadata:
  name: ipoib-test-pod-{{printf "%c" (add 97 $i)}}
  namespace: default
  annotations:
    k8s.v1.cni.cncf.io/networks: {{$.Ipoib.NetworkName}}-{{printf "%c" (add 97 $i)}}
spec:
  {{- if $.ClusterConfig.NodeSelector }}
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          {{- range $key, $value := $.ClusterConfig.NodeSelector }}
          - key: {{ $key }}
            {{- if ne $value "" }}
            operator: In
            values:
            - {{ $value }}
            {{- else }}
            operator: Exists
            {{- end }}
          {{- end }}
  {{- end }}
  containers:
  - name: test-container
    image: mellanox/rping-test
    command: ["/bin/bash", "-c", "sleep infinity"]
    securityContext:
      capabilities:
        add: ["IPC_LOCK"]
    resources:
      requests:
        rdma/{{$.RdmaShared.ResourceName}}-{{printf "%c" (add 97 $i)}}: 1
      limits:
        rdma/{{$.RdmaShared.ResourceName}}-{{printf "%c" (add 97 $i)}}: 1
{{if ne $i (sub (len $.ClusterConfig.PFs) 1)}}---{{end -}}
{{end}}
{{- end}}
{{else}}
{{/* Create single test pod for shared or first device network */}}
apiVersion: v1
kind: Pod
metadata:
  name: ipoib-test-pod
  annotations:
    k8s.v1.cni.cncf.io/networks: {{.Ipoib.NetworkName}}
spec:
  {{- if $.ClusterConfig.NodeSelector }}
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          {{- range $key, $value := $.ClusterConfig.NodeSelector }}
          - key: {{ $key }}
            {{- if ne $value "" }}
            operator: In
            values:
            - {{ $value }}
            {{- else }}
            operator: Exists
            {{- end }}
          {{- end }}
  {{- end }}
  containers:
  - name: test-container
    image: mellanox/rping-test
    command: ["/bin/bash", "-c", "sleep infinity"]
    securityContext:
      capabilities:
        add: ["IPC_LOCK"]
    resources:
      requests:
        rdma/{{.RdmaShared.ResourceName}}: 1
      limits:
        rdma/{{.RdmaShared.ResourceName}}: 1
{{end}}